# Maintainer: ArchStrike <team@archstrike.org>

buildarch=200

pkgname=smartphone-pentest-framework-git
pkgver=20150913.r104
pkgrel=2
groups=('archstrike' 'archstrike-backdoors')
pkgdesc="Repository for the Smartphone Pentest Framework (SPF)"
arch=('i686' 'x86_64' 'aarch64')
url='https://github.com/georgiaw/Smartphone-Pentest-Framework'
license=('custom')
depends_x86_64+=('python2' 'apache' 'php-apache' 'apache-ant' 'mysql' 'python2-pyserial' 'python2-pexpect' 'mysql-python' 'lib32-gcc-libs' 'lib32-zlib')
depends=('python2' 'apache' 'php-apache' 'apache-ant' 'mysql' 'python2-pyserial' 'python2-pexpect' 'mysql-python')
makedepends=('git')
provides=('smartphone-pentest-framework')
conflicts=('smartphone-pentest-framework')
replaces=('smartphone-pentest-framework')
install=${pkgname}.install
source=("${pkgname}::git+https://github.com/georgiaw/Smartphone-Pentest-Framework.git")
options=('!strip')
sha512sums=('SKIP')

pkgver() {
    cd "${pkgname}"
    printf "%s.r%s" "$(git show -s --format=%ci master | sed 's/\ .*//g;s/-//g')" "$(git rev-list --count HEAD)"
}

prepare(){
  grep -iRl 'python' ${pkgname} | xargs sed -i 's|python$|python2|'
}

package() {
  cd "${pkgname}"

  #clean up
  rm -fv "*install*"

  # Make base directories.
  install -dm755 "$pkgdir/usr/share/$pkgname"
  install -dm755 "$pkgdir/usr/bin"

  # Setup dirs
  for i in APKs AgentTemplates FrameworkAndroidApp FrameworkAndroidAppwithNFC arm-linux-androideabi-4.6 exploits frameworkconsole; do
      install -dm755 "$pkgdir/usr/share/$pkgname/$i"; done

  #Docs
  install -Dm644 "Version" "$pkgdir/usr/share/$pkgname/Version"
  install -Dm644 "README.md" "$pkgdir/usr/share/$pkgname/README.md"
  install -Dm644 "Smartphone Pentest Framework Manual.pdf" "$pkgdir/usr/share/$pkgname/Smartphone Pentest Framework Manual.pdf"
  install -Dm644 "license.rtf" "$pkgdir/usr/share/licenses/$pkgname/license.rtf"

  #Copy files into setup dirs
  for i in APKs AgentTemplates FrameworkAndroidApp FrameworkAndroidAppwithNFC arm-linux-androideabi-4.6 exploits frameworkconsole; do
      cp -a --no-preserve=ownership $i/* "$pkgdir/usr/share/$pkgname/$i/"; done

  #Configure config file for arch
  cd "$pkgdir/usr/share/$pkgname/frameworkconsole/"
  sed -i 's|/var/www|/srv/http|' config
  sed -i 's|/usr/share/android-sdk|/opt/android-sdk|' config
  sed -i 's|/root/Smartphone-Pentest-Framework/|/usr/share/smartphone-pentest-framework-git/|' config

cat > "$pkgdir/usr/bin/smartphone-pentest-framework" << EOF
#!/bin/sh
cd /usr/share/smartphone-pentest-framework-git/frameworkconsole
python2 framework.py "\$@"
EOF
chmod 755 "$pkgdir/usr/bin/smartphone-pentest-framework"
}
