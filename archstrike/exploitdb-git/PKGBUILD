# Maintainer: ArchStrike <team@archstrike.org>

buildarch=1

pkgname=exploitdb-git
pkgver=20170201.r1126
pkgrel=1
groups=('archstrike' 'archstrike-exploit')
pkgdesc="The official Exploit Database repository"
arch=('any')
url='https://github.com/offensive-security/exploit-database'
license=('GPL')
depends=('bash')
makedepends=('git')
options=('!strip')
replaces=('exploit-db')
conflicts=('exploit-db')
provides=('exploit-database' 'exploit-db' 'exploitdb')
source=("${pkgname}::git+https://github.com/offensive-security/exploit-database.git" 'gitpath.patch')
sha512sums=('SKIP'
            '4a44549343f0edfb3dac4014b9056e5ddc80bf145636452fc313a631d41c1f3f125ba52b7956423add3f899f7f94c8c8cc0d7399598e41302d82dacff6c1f9a0')

pkgver() {
  cd "${pkgname}"
  printf "%s.r%s" "$(git show -s --format=%ci master | sed 's/\ .*//g;s/-//g')" "$(git rev-list --count HEAD)"
}

prepare() {
  cd "${pkgname}"
  patch -Np1 -i ${srcdir}/gitpath.patch
}

package() {
  cd "${pkgname}"
  install -dm755 "${pkgdir}/usr/bin"
  install -dm755 "${pkgdir}/usr/share/${pkgname}/platforms"
  cp -a --no-preserve=ownership platforms/* "${pkgdir}/usr/share/${pkgname}/platforms"
  install -m644 "README.md" "${pkgdir}/usr/share/${pkgname}/README.md"
  install -m644 "files.csv" "${pkgdir}/usr/share/${pkgname}/files.csv"
  install -m755 "searchsploit" "${pkgdir}/usr/share/${pkgname}/searchsploit"

cat > "${pkgdir}/usr/bin/searchsploit" <<EOF
#!/usr/bin/env bash
cd /usr/share/${pkgname}
./searchsploit "\$@"
EOF
chmod 755 "${pkgdir}/usr/bin/searchsploit"
}
