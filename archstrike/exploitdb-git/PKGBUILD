# Maintainer: ArchStrike <team@archstrike.org>

buildarch=1

pkgname=exploitdb-git
pkgver=20180320.r1514
pkgrel=1
groups=('archstrike' 'archstrike-exploit')
pkgdesc="The official Exploit Database repository"
arch=('any')
url='https://github.com/offensive-security/exploit-database'
license=('GPL')
depends=('bash')
makedepends=('git')
options=('!strip')
replaces=('exploit-db')
conflicts=('exploit-db')
provides=('exploit-database' 'exploit-db' 'exploitdb')
source=("${pkgname}::git+https://github.com/offensive-security/exploit-database.git" "rcfile.patch")
sha512sums=('SKIP'
            '31b54c8b8eb78a2e1a4e1710b7bd2b0a649755bc67ecbeeb90397fa3132dd08e29c2777fd52c9aa70e9301f299dd885d85af1d1ce0ac4d04043ecbb903191ead')

pkgver() {
  cd "${pkgname}"
  printf "%s.r%s" "$(git show -s --format=%ci master | sed 's/\ .*//g;s/-//g')" "$(git rev-list --count HEAD)"
}

prepare() {
  cd "${pkgname}"
  patch -Np1 -i ${srcdir}/rcfile.patch
}

package() {
  cd "${pkgname}"
  install -dm755 "${pkgdir}/usr/bin"
  install -dm755 "${pkgdir}/usr/share/${pkgname}/platforms"
  cp -a --no-preserve=ownership * "${pkgdir}/usr/share/${pkgname}"
  cp .searchsploit_rc "${pkgdir}/usr/share/${pkgname}"

cat > "${pkgdir}/usr/bin/searchsploit" <<EOF
#!/usr/bin/env bash
cd /usr/share/${pkgname}
./searchsploit "\$@"
EOF
chmod 755 "${pkgdir}/usr/bin/searchsploit"
}
